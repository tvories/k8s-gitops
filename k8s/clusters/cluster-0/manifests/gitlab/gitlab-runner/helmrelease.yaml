---
apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: gitlab-runner
  namespace: gitlab
spec:
  interval: 30m
  chart:
    spec:
      chart: gitlab-runner
      version: 0.85.0
      sourceRef:
        kind: HelmRepository
        name: gitlab-charts
        namespace: flux-system
  maxHistory: 2
  install:
    remediation:
      retries: 3
  upgrade:
    cleanupOnFail: true
    remediation:
      retries: 3
  uninstall:
    keepHistory: false
  values:
    # GitLab URL
    gitlabUrl: https://gitlab.t-vo.us

    # Disable registration token (deprecated)
    runnerRegistrationToken: ""

    # Runner token is provided via secret
    runners:
      # Use existing secret with authentication token
      secret: gitlab-runner-secret

      # Runner configuration
      config: |
        [[runners]]
          [runners.kubernetes]
            namespace = "{{.Release.Namespace}}"
            image = "nixos/nix:2.33.1"
            privileged = false
            cpu_request = "100m"
            memory_request = "128Mi"
            service_cpu_request = "100m"
            service_memory_request = "128Mi"
            helper_cpu_request = "100m"
            helper_memory_request = "128Mi"

    # Resource limits
    resources:
      limits:
        memory: 256Mi
        cpu: 200m
      requests:
        memory: 128Mi
        cpu: 100m
