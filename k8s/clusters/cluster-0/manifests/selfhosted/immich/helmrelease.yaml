apiVersion: helm.toolkit.fluxcd.io/v2
kind: HelmRelease
metadata:
  name: immich
  namespace: selfhosted
spec:
  interval: 15m
  chart:
    spec:
      chart: immich
      version: 0.10.3
      sourceRef:
        kind: HelmRepository
        name: immich-charts
        namespace: flux-system
      interval: 15m
  values:
    # Valkey (Redis replacement) - new in v0.10.0
    valkey:
      enabled: true
      auth:
        existingSecret: immich-secret
        existingSecretPasswordKey: REDIS_PASSWORD

    # Persistence for photo library (mount path changed to /data in v0.10.0)
    immich:
      persistence:
        library:
          existingClaim: immich-nfs

    # Database configuration - set at top level for all components
    env:
      DB_DATABASE_NAME: immich
      DB_HOSTNAME: postgres.database.svc.cluster.local
      DB_PORT: "5432"
      DB_USERNAME:
        valueFrom:
          secretKeyRef:
            name: immich-secret
            key: DB_USERNAME
      DB_PASSWORD:
        valueFrom:
          secretKeyRef:
            name: immich-secret
            key: DB_PASSWORD
      REDIS_HOSTNAME: immich-valkey
      REDIS_PASSWORD:
        valueFrom:
          secretKeyRef:
            name: immich-secret
            key: REDIS_PASSWORD

    image:
      # renovate: datasource=github-releases depName=immich-app/immich
      tag: "v2.4.1"

    # Server configuration - common library 4.x structure
    server:
      controller:
        replicas: 1
      resources:
        requests:
          cpu: 1500m
          memory: 2048M
      ingress:
        main:
          enabled: true
          className: nginx-internal
          annotations:
            cert-manager.io/cluster-issuer: letsencrypt-production
            nginx.ingress.kubernetes.io/proxy-body-size: "0"
          hosts:
            - host: &host "photos.${SECRET_DOMAIN}"
              paths:
                - path: /
                  pathType: Prefix
                  service:
                    identifier: main
                    port: http
          tls:
            - hosts:
                - *host
              secretName: *host

    # Machine Learning configuration - common library 4.x structure
    machine-learning:
      controller:
        replicas: 1
      resources:
        requests:
          cpu: 100m
          memory: 2048M
      # Relaxed probes for library migration (mount path changed to /data)
      probes:
        liveness:
          enabled: true
          custom: true
          spec:
            httpGet:
              path: /ping
              port: http
            initialDelaySeconds: 0
            periodSeconds: 10
            timeoutSeconds: 1
            failureThreshold: 3
        readiness:
          enabled: true
          custom: true
          spec:
            httpGet:
              path: /ping
              port: http
            initialDelaySeconds: 0
            periodSeconds: 10
            timeoutSeconds: 1
            failureThreshold: 3
        startup:
          enabled: true
          custom: true
          spec:
            httpGet:
              path: /ping
              port: http
            initialDelaySeconds: 0
            periodSeconds: 10
            timeoutSeconds: 1
            failureThreshold: 30
